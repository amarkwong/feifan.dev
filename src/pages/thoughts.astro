---
import Layout from '../layouts/Layout.astro';
import { fetchNotionArticle, fetchChildPages } from '../lib/notion';
import { deriveNotionEmbedSrc, deriveNotionSlug, normalizeNotionId } from '../lib/notionEmbed';
import { blogEntries, blogCollections } from '../data/blogEntries';

interface WritingCard {
  title: string;
  summary: string;
  status: string;
  href: string;
  updatedAt: string;
  slug?: string;
  notionPageId?: string;
  normalizedPageId?: string | null;
  embedSrc?: string | null;
}

const fallbackEssays: WritingCard[] = [
  {
    title: 'Hydration budgets for Astro islands',
    summary:
      'A framework for sizing interactive islands, picking the right renderer, and staying honest about the JavaScript tax.',
    status: 'IN PROGRESS',
    href: '/blog/hydration-budgets',
    updatedAt: '2024-01-01',
  },
  {
    title: 'Shipping calm dark-mode toggles',
    summary:
      'Design notes from building a preference-aware theme switcher without layout jank or surprise flashes.',
    status: 'PUBLISHED',
    href: '/blog/calm-dark-mode',
    updatedAt: '2023-12-15',
  },
  {
    title: 'Designing engineer-friendly rituals',
    summary:
      'Reflections on weekly demos, debugging salons, and other lightweight practices that keep teams curious.',
    status: 'NOTEBOOK',
    href: '/blog/rituals-for-engineers',
    updatedAt: '2023-11-05',
  },
];

function summarizeHtml(html: string, maxLength = 180) {
  if (!html) return '';
  const text = html.replace(/<[^>]+>/g, ' ').replace(/\s+/g, ' ').trim();
  if (!text) return '';
  if (text.length <= maxLength) return text;
  return text.slice(0, maxLength).trimEnd() + '…';
}

function toStatusLabel(label?: string) {
  return (label ?? 'Published').toUpperCase();
}

function ensureTitle(...candidates: Array<string | undefined | null>) {
  for (const candidate of candidates) {
    if (candidate && candidate.trim() && candidate.trim().toLowerCase() !== 'untitled') {
      return candidate.trim();
    }
  }
  return 'Untitled';
}

async function fetchBlogHighlights(limit = 6): Promise<WritingCard[]> {
  try {
    const manualCards = await Promise.all(
      blogEntries.map(async (entry) => {
        const article = await fetchNotionArticle(entry.notionPageId);
        if (!article) return null;
        const summary = entry.summary || summarizeHtml(article.content ?? '');
        const normalizedId = normalizeNotionId(entry.notionPageId);
        const slug = deriveNotionSlug({
          publicUrl: article.publicUrl,
          title: article.title,
          fallbackSlug: entry.slug,
          pageId: entry.notionPageId,
        });
        const embedSrc = deriveNotionEmbedSrc(article.publicUrl, entry.notionPageId);
        return {
          title: ensureTitle(article.title, entry.titleOverride, entry.slug),
          summary: summary || 'Read this piece on Notion.',
          status: toStatusLabel(entry.tags?.[0]),
          href: article.publicUrl || `/blog/${entry.slug}`,
          slug,
          notionPageId: entry.notionPageId,
          normalizedPageId: normalizedId,
          embedSrc,
          updatedAt: article.updatedAt ?? new Date().toISOString(),
        } as WritingCard;
      })
    );

    const collectionCards = (
      await Promise.all(
        blogCollections.map(async (collection) => {
          const children = await fetchChildPages(collection.parentPageId);
          return Promise.all(
            children.map(async (child) => {
              const article = await fetchNotionArticle(child.id);
              if (!article) return null;
              const summary = summarizeHtml(article.content ?? '') || collection.summary;
              const normalizedId = normalizeNotionId(child.id);
              const slug = deriveNotionSlug({
                publicUrl: article.publicUrl || child.publicUrl,
                title: article.title ?? child.title,
                fallbackSlug: child.title,
                pageId: child.id,
              });
              const embedSrc = deriveNotionEmbedSrc(article.publicUrl || child.publicUrl, child.id);
              return {
                title: ensureTitle(article.title, child.title),
                summary: summary || 'Read this piece on Notion.',
                status: toStatusLabel(collection.tags?.[0]),
                href: article.publicUrl || child.publicUrl || `/blog/${child.id}`,
                slug,
                notionPageId: child.id,
                normalizedPageId: normalizedId,
                embedSrc,
                updatedAt: article.updatedAt ?? new Date().toISOString(),
              } as WritingCard;
            })
          );
        })
      )
    ).flat();

    return [...manualCards, ...collectionCards]
      .filter((card): card is WritingCard => Boolean(card))
      .sort((a, b) => new Date(b.updatedAt).getTime() - new Date(a.updatedAt).getTime())
      .slice(0, limit);
  } catch (error) {
    console.error('[Thoughts] Failed to fetch blog highlights', error);
    return [];
  }
}

const blogHighlights = await fetchBlogHighlights(3);
const essays = blogHighlights.length ? blogHighlights : fallbackEssays;

const signalBoosts = [
  {
    title: 'Office hours · Energy analysts',
    detail: 'Monthly sessions reverse-engineering ERSA pricing flows and TEEMS data hygiene.',
    href: 'mailto:hi@feifan.dev?subject=Energy%20office%20hours',
  },
  {
    title: 'Case study · Edge portal modernization',
    detail: 'Architecture notes on porting calculators and workflows onto Azure Functions + SQL Managed Instance.',
    href: '/thoughts',
  },
  {
    title: 'Toolkit · Notion delivery hub',
    detail: 'An ops template that keeps boutique consultancies in sync across briefs, docs, and Julia experiments.',
    href: 'mailto:hi@feifan.dev?subject=Notion%20delivery%20hub',
  },
];

const readingList = [
  {
    title: 'Shorting the Grid',
    author: 'Meredith Angwin',
    note: 'Grounding Australian energy-market conversations in practical reliability history.',
  },
  {
    title: 'Numbers Don’t Lie',
    author: 'Vaclav Smil',
    note: 'Keeps modeling instincts anchored in real-world energy + infrastructure data.',
  },
  {
    title: 'Shape Up',
    author: 'Ryan Singer',
    note: 'Guides how I frame six-week consulting arcs for SMEs.',
  },
];

const nowFocus = [
  'Prototyping Julia models that forecast DER scenarios for boutique retailers.',
  'Automating TEEMS ⇄ Notion handoffs so ops teams get cleaner briefs.',
  'Documenting migration patterns from monolithic portals to Azure Functions.',
];
---

<Layout title="Thoughts — feifan.dev">
  <header class="thoughts-hero glass-panel">
    <span class="chip">Notes, riffs, and signal boosts</span>
    <h1>Thoughts is my digital studio log.</h1>
    <p>
      Essays, experiments, and field notes on building calm interfaces, intentional teams, and tools
      that keep the web weird. It is equal parts notebook and broadcast channel.
    </p>
    <div class="thoughts-hero__actions">
      <a class="hero-cta" href="mailto:hi@feifan.dev?subject=Let%27s%20collaborate">Say hi</a>
      <a class="hero-secondary" href="#writing">Skip to writing</a>
    </div>
  </header>

  <section id="writing" class="thoughts-section thoughts-section--carousel">
    <div class="section-heading">
      <h2>Latest writing</h2>
      <p>Published articles, drafts, and living notebooks.</p>
    </div>
    <div class="carousel" data-carousel>
      <button class="carousel-control" data-dir="prev" aria-label="Show previous writing">
        <span class="sr-only">Show previous writing</span>
        <svg viewBox="0 0 20 20" aria-hidden="true">
          <path d="M12.5 5l-5 5 5 5" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" fill="none" />
        </svg>
      </button>
      <div class="carousel-track" data-carousel-track>
        {essays.map((essay) => {
          const hasEmbed = Boolean(essay.slug && essay.notionPageId && essay.embedSrc);
          const articleHref = hasEmbed ? `/thoughts/${essay.slug}` : essay.href;
          return (
            <article class="essay-card">
              <span class="essay-status">{essay.status}</span>
              <h3>
                <a href={articleHref} transition:animate={hasEmbed ? 'fade' : undefined} target={hasEmbed ? undefined : '_blank'} rel={hasEmbed ? undefined : 'noreferrer'}>
                  {essay.title}
                </a>
              </h3>
              <p>{essay.summary}</p>
              <a
                class="ghost-link"
                href={articleHref}
                transition:animate={hasEmbed ? 'fade' : undefined}
                target={hasEmbed ? undefined : '_blank'}
                rel={hasEmbed ? undefined : 'noreferrer'}
              >
                Read the piece ↗
              </a>
            </article>
          );
        })}
      </div>
      <button class="carousel-control" data-dir="next" aria-label="Show next writing">
        <span class="sr-only">Show next writing</span>
        <svg viewBox="0 0 20 20" aria-hidden="true">
          <path d="M7.5 5l5 5-5 5" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" fill="none" />
        </svg>
      </button>
    </div>
  </section>

  <section class="thoughts-section thoughts-section--split">
    <div>
      <h2>Signal boosts</h2>
      <ul class="signal-list">
        {signalBoosts.map((item) => (
          <li>
            <h3>{item.title}</h3>
            <p>{item.detail}</p>
            <a class="ghost-link" href={item.href}>
              View details ↗
            </a>
          </li>
        ))}
      </ul>
    </div>
    <div>
      <h2>Now reading</h2>
      <ul class="reading-list">
        {readingList.map((book) => (
          <li>
            <div>
              <h3>{book.title}</h3>
              <span>{book.author}</span>
            </div>
            <p>{book.note}</p>
          </li>
        ))}
      </ul>
    </div>
  </section>

  <section class="thoughts-section thoughts-section--focus">
    <h2>What I am exploring right now</h2>
    <ul>
      {nowFocus.map((item) => (
        <li>{item}</li>
      ))}
    </ul>
  </section>
</Layout>

<script is:inline>
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('[data-carousel]').forEach((carousel) => {
      const track = carousel.querySelector('[data-carousel-track]');
      if (!(track instanceof HTMLElement)) return;

      const rotate = (direction) => {
        if (direction === 'prev') {
          const last = track.lastElementChild;
          if (last) {
            track.insertBefore(last, track.firstElementChild);
          }
        } else if (direction === 'next') {
          const first = track.firstElementChild;
          if (first) {
            track.appendChild(first);
          }
        }
        track.scrollLeft = 0;
      };

      const handleControl = (dir) => {
        if (dir === 'prev' || dir === 'next') {
          rotate(dir);
        }
      };

      carousel.addEventListener('click', (event) => {
        const origin = event.target;
        const control = origin instanceof Element ? origin.closest('[data-dir]') : null;
        if (!(control instanceof HTMLElement)) return;
        const dir = control.getAttribute('data-dir');
        handleControl(dir);
      });

      carousel.addEventListener('keydown', (event) => {
        if (event.key === 'ArrowLeft') {
          event.preventDefault();
          handleControl('prev');
        }
        if (event.key === 'ArrowRight') {
          event.preventDefault();
          handleControl('next');
        }
      });
    });
  });
</script>

<style>
  .thoughts-hero {
    padding: 3rem;
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
  }

  .thoughts-hero h1 {
    font-size: clamp(2.5rem, 4vw, 3.5rem);
    margin: 0;
    line-height: 1.1;
  }

  .thoughts-hero p {
    margin: 0;
    font-size: 1.1rem;
    color: var(--text-muted);
  }

  .thoughts-hero__actions {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
  }

  .hero-cta,
  .hero-secondary {
    text-decoration: none;
    padding: 0.85rem 1.5rem;
    border-radius: 999px;
    font-weight: 600;
    font-size: 1rem;
    transition: transform 0.2s ease, background 0.2s ease, color 0.2s ease;
  }

  .hero-cta {
    background: var(--accent);
    color: #fff;
  }

  .hero-secondary {
    border: 1px solid var(--panel-border);
    color: var(--text-primary);
  }

  .hero-cta:hover,
  .hero-cta:focus-visible,
  .hero-secondary:hover,
  .hero-secondary:focus-visible {
    transform: translateY(-2px);
  }

  .thoughts-section {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
  }

  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }

  .thoughts-section--carousel {
    position: relative;
  }

  .thoughts-section--carousel .carousel {
    position: relative;
    padding-top: 0;
  }

  .carousel-track {
    display: flex;
    flex-wrap: nowrap;
    gap: 1.25rem;
    overflow-x: auto;
    overflow-y: hidden;
    scroll-behavior: smooth;
    scroll-snap-type: x proximity;
    scrollbar-width: none;
    -ms-overflow-style: none;
  }

  .carousel-track::-webkit-scrollbar {
    display: none;
  }

  .carousel-control {
    border: 1px solid var(--panel-border);
    background: #fff;
    color: var(--text-primary);
    border-radius: 999px;
    width: 2.5rem;
    height: 2.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
    cursor: pointer;
    transition: transform 0.2s ease, opacity 0.2s ease;
    position: absolute;
    top: 50%;
    transform: translate(-50%, -50%);
    z-index: 2;
  }

  .carousel-control svg {
    width: 1.25rem;
    height: 1.25rem;
    pointer-events: none;
  }

  .carousel-control[data-dir='prev'] {
    left: -1.25rem;
  }

  .carousel-control[data-dir='next'] {
    right: -1.25rem;
    transform: translate(50%, -50%);
  }

  .carousel-control:disabled {
    opacity: 0.35;
    cursor: not-allowed;
  }

  .carousel-control[data-dir='prev']:not(:disabled):hover,
  .carousel-control[data-dir='prev']:not(:disabled):focus-visible {
    transform: translate(-50%, -50%) translateY(-1px);
  }

  .carousel-control[data-dir='next']:not(:disabled):hover,
  .carousel-control[data-dir='next']:not(:disabled):focus-visible {
    transform: translate(50%, -50%) translateY(-1px);
  }

  .section-heading h2 {
    margin: 0;
  }

  .section-heading p {
    margin: 0;
  }

  .essay-card {
    padding: 1.25rem 1.5rem;
    border: 1px solid var(--panel-border);
    border-radius: 16px;
    background: var(--panel-bg);
    box-shadow: var(--panel-shadow);
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    min-height: 200px;
    flex: 0 0 clamp(280px, 55vw, 420px);
    scroll-snap-align: start;
  }

  .essay-status {
    font-size: 0.8rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--text-muted);
  }

  .essay-card h3 {
    margin: 0;
  }

  .essay-card h3 a {
    color: inherit;
    text-decoration: none;
  }

  .essay-card h3 a:hover,
  .essay-card h3 a:focus-visible {
    text-decoration: underline;
  }

  .ghost-link {
    text-decoration: none;
    color: var(--text-muted);
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    font-weight: 500;
  }

  .ghost-link:hover,
  .ghost-link:focus-visible {
    color: var(--text-primary);
  }

  .thoughts-section--split {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 1.5rem;
  }

  .thoughts-section--split > div {
    padding: 1.5rem;
    border: 1px solid var(--panel-border);
    border-radius: 16px;
    background: var(--panel-bg);
    box-shadow: var(--panel-shadow);
  }

  .signal-list,
  .reading-list,
  .thoughts-section--focus ul {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .signal-list h3,
  .reading-list h3 {
    margin: 0;
  }

  .reading-list span {
    font-size: 0.85rem;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    color: var(--text-muted);
  }

  .thoughts-section--focus ul li {
    padding: 0.85rem 1.25rem;
    border-radius: 12px;
    border: 1px dashed rgba(11, 11, 11, 0.12);
    background: rgba(0, 0, 0, 0.02);
  }

  @media (max-width: 720px) {
    .thoughts-hero {
      padding: 2.25rem;
    }
    .carousel-control {
      position: static;
      transform: none;
      margin-top: 0.75rem;
    }
    .carousel-track {
      gap: 1rem;
    }
    .essay-card {
      flex-basis: min(85vw, 360px);
    }
  }
</style>
